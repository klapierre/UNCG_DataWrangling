---
title: "TEMPEST: Understory plant community responses to coastal flooding"
author: "William Eichhorn"
date: "2023-03-20"
output: pdf_document
---
```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = '~/UNCG_DataWrangling')
```

# Background

As climate change continues, the frequency and intensity of thunderstorms and 
heavy rainfall will continue to rise. The point of this experiment is to study
the effects of sudden heavy rain on the under story of forests. 


First, let's set up R, our tidyverse library, and the theme we want to use 
across all of our coding chunks
```{r, library, message=FALSE, warning=FALSE}
library(tidyverse)
theme_set(theme_dark())
```


Great! Now lets load in the dataset
```{r,read.csv}
tempest <- read.csv("TEMPEST_SERC_understory sppcomp_2021.csv")

```


Next, we are going to create a dataframe which only pertains to species info
```{r}

temp_species <- tempest %>% 
  select(species, cover) %>% 
  distinct(.keep_all = TRUE) %>%
  mutate(species = ifelse(species=="canopy tree basal cover", NA, ifelse(species==
         "infrastructure cover",NA, ifelse(species=="bare ground", NA, species))))%>%
  filter(!is.na(species))
```


Next, we will create a dataframe which only contains treatment information
and combines the plots and subplots into a new column termed "replicate"
```{r}
temp_treatment <- tempest %>% 
  mutate(replicate = paste(plot, subplot, sep="_")) %>%
  mutate(treatment = ifelse(plot %in% "C", "Control",plot)) %>% 
  mutate(treatment = ifelse(plot %in% "F", "Freshwater inundation",treatment)) %>% 
  mutate(treatment = ifelse(plot %in% "S", "Saltwater inundation", treatment)) %>% 
  select(-c("project_name", "sampler","notes","species","plot","subplot")) 

```


Now we must find the cover percentage of herbaceous species. First we will
filter out the species which are non-plants
```{r}

plant_cover <- tempest %>% 
  mutate(species = ifelse(species=="canopy tree basal cover", NA, ifelse(species==
         "infrastructure cover",NA, ifelse(species=="bare ground", NA, species))))%>%
  filter(!is.na(species))
```


Now we need to find the plant cover of each subplot
```{r}
cover_combine <- plant_cover%>%
  group_by(subplot)%>%
  summarise(plantcover_total=sum(cover))%>%
  mutate(subplot = ifelse(subplot=="additional", NA, subplot)) %>% 
  filter(!is.na(subplot))%>%
  ungroup()
```

Finally, combine this back into the original dataframe and create a new column
with the individual species cover divided by the total to find the relative
percentage of plant cover for each subplot
```{r}
tempest <- merge(x=tempest, y=cover_combine, by="subplot", all.x=T) %>% 
  mutate(.data=tempest, plantcover_percent = 100*(cover/plantcover_total))

```

Now we will need to find species richness at the subplot level, along with mean and standard error of
each plot

```{r,message=FALSE}

subplot_rich <- tempest %>%
  group_by(subplot,plot) %>% 
  distinct(across(contains("species")),(.keep_all = TRUE)) %>% 
  summarise(species_richness = length(species)) %>% 
  ungroup()%>%
  group_by(plot)%>%
  mutate(across(.col="species_richness",.fns=list(mean=mean,sd=sd),na.rm=TRUE))%>%
  mutate(richness_se=1.96*species_richness_sd)%>%
  ungroup()

```

Next, we find just the species richness at the plot level

```{r}
plot_rich <- tempest %>%
  group_by(plot) %>% 
  distinct(across(contains("species")),(.keep_all = TRUE)) %>% 
  summarise(species_richness = length(species)) %>% 
  ungroup()

```


Here we have a bargraph of the mean species richness by subplot
```{r,ggplot}

ggplot(data=subplot_rich, aes(x=subplot, y=species_richness_mean, fill=plot))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=c("lightgrey", "gold", "orange"))+
  xlab("Sublot")+
  ylab("Species Richness")+
  geom_errorbar(aes(ymin=species_richness_mean-richness_se, 
                    ymax=species_richness_mean+richness_se), 
                    position=position_dodge(), linewidth=.2, size=1)
```