---
title: 'TEMPEST: Understory plant community responses to coastal flooding'
author: "Jordan Winter"
date: "2023-03-27"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro

Some of the most frequent natural weather phenomena in the United States include torrential rain and storm surges.
These occurrences are happening more frequently and with increasing severity due to worsening climate change, with significant negative effects on human health, the economy, and the environment.
Researchers at the Smithsonian Environmental Research Center are examining how unexpected downpours could affect woods in a nearby forest.
To this purpose, they've set up an experiment dubbed TEMPEST, which stands for Terrestrial Ecosystem Manipulation to Investigate the Impacts of Storm Treatments.Inundating portions of the forest will simulate severe freshwater rainstorms and saltwater storm surges. 

At three sizable plots at the Smithsonian Environmental Research Center in Edgewater, Maryland, the data for this project analyzes the communities of the forest understory. Prior to the start of the inundation experiment in 2020, the species cover inside each plot was calculated to see whether there were any pre-existing natural variances between plots. This information will help with the statistical analysis of the outcomes of flooding remedies.

The estimated percent cover of each plant species (or some other type of infrastructure that took up space but wasn't a plant species, such as infrastructure cover, canopy tree basal cover, or bare ground) was observed in one of the 16 5x5 m subplots that were found inside one of three 40 m by 50 m plots (C, F, and S). 

```{r libs and df}
library(tidyverse)
df <- read.csv("TEMPEST_SERC_understory sppcomp_2021.csv", header = T)
```

## Set a theme

```{r theme, echo=TRUE, results='hide'}
theme_minimal()
```

## Get rid of non-plants in df

``` {r get rid of non-plants}
dfplants <- df %>% filter(!str_detect(species,c("infrastructure")))  %>% filter(!str_detect(species,c("bare"))) %>% filter(!str_detect(species,c("basal"))) %>% 
  filter(!str_detect(subplot,c("additional")))
```

## Create df: A species list that contains a column of all plant species found within the experiment (no repeats and be sure to remove non-plants!).

``` {r species list}
SpeciesList <- as.data.frame(unique(dfplants$species)) %>% rename("species" = "unique(dfplants$species)")
```

## Create another df: just the treatment info

``` {r just treatment df}
treatmentinfo <- dfplants %>% mutate(replicate = paste(plot, subplot, sep = "")) %>% 
  mutate(plottype = ifelse(plot %in% "C", "Control", plot)) %>% 
  mutate(plottype = ifelse(plot %in% "F", "Freshwater inundation", plottype)) %>%
  mutate(plottype = ifelse(plot %in% "S", "Saltwater inundation", plottype)) %>% 
  select(-c("project_name":"season")) %>% select(-sampler,-notes, -species,-cover)
```

## #Calculate the total herbaceous plant cover (remove non-plants) for each subplot in a new data frame, removing any "additional" species. Then join that data frame back onto the original cover data. Calculate the relative cover for each species as 100*(species cover/total cover).

``` {r losing steam}
totalHERBcover <- dfplants %>% group_by(subplot) %>% mutate(totalcover = sum(cover)) %>% ungroup()

Speciesrelativecover <- totalHERBcover %>% group_by(species) %>% mutate(relativecover = (100 * (cover/totalcover))) %>% ungroup()
```

## Calculate plant species richness (the total number of plant species) for each subplot.

```{r plant sp rich}

subplotsprich <- dfplants %>% group_by(subplot) %>% mutate(subplotrichness = n_distinct(species)) %>% ungroup()

plotrichness <- subplotsprich %>% group_by(plot) %>% mutate(plotrichness = n_distinct(species)) %>% ungroup()
```

## Create a function to calculate Sd Error

```{r stderr function}
std.error <- function(x) sd(x)/sqrt(length(x))
```

## Calculate mean species richness @  the plot level
``` {r}
MeanSpRichandStdErr <- plotrichness %>%  group_by(plot) %>% mutate(meanspeciesrichness = mean(subplotrichness)) %>% 
  mutate(speciesrichnessSTDERR = std.error(subplotrichness)) %>% ungroup()
```


## In another dataframe, calculate plant species richness at the plot level (including the additional species not found in the subplot data).

``` {r}
PlantSpeciesRichOnly <- MeanSpRichandStdErr %>% group_by(plot) %>% summarise(speciesrich = n_distinct(species)) %>% ungroup()
```

## Bar graph of richness per plot (plot on x-axis) showing the mean and standard error across subplots.
```{r}
ggplot(MeanSpRichandStdErr, aes(x = plot, y = meanspeciesrichness), fill = as.factor(plot)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = meanspeciesrichness - speciesrichnessSTDERR, 
                    ymax = meanspeciesrichness + speciesrichnessSTDERR)) + ylim(0, 50) + xlab("Plot") + ylab("Mean Subplot Species Richness")
```


## Another bar graph showing the richness at the plot level (plot on x-axis).  

```{r}
ggplot(PlantSpeciesRichOnly, aes(x = plot, y = speciesrich)) +
  geom_bar(stat = "identity") + xlab("Plot") + ylab("Species Richness (at plot level)")
```

## Calculate the average relative cover for each species across all subplots within each plot. Then calculate the average relative cover for each species across all plots. In the end you should have a data frame with two columns: species and average relative cover.

```{r}
species_cover <- dfplants %>%
  group_by(plot, species) %>%
  summarise(avg_rel_cover = mean(cover))
```

## Calculate the average relative cover for each species across all plots
```{r}
species_cover_all <- species_cover %>%
  group_by(species) %>%
  summarise(avg_rel_cover = mean(avg_rel_cover))
```

## Sort the data frame you created from highest to lowest relative cover. Hint: use code to do this otherwise it won't stick! 

```{r}
Sp_cov_ranked <- species_cover_all %>% arrange(desc(avg_rel_cover))
```

## Create a new column in your data frame that gives each species a rank (number from 1 to X) based on their abundance where 1=most abundant.
```{r}
Sp_cov_ranked <- Sp_cov_ranked %>% mutate(number = 1:91)
```

## Make a figure with points connected by lines of the rank on the x-axis and the relative cover on the y-axis.Use geom_text to label your points with the species names and be sure to give your axes intelligible labels.

```{r}
ggplot(Sp_cov_ranked, aes(x = number, y = avg_rel_cover)) +
  geom_point() +
  geom_line() +
  geom_text(aes(label = species)) +
  xlab("Rank") +
  ylab("Avg Relative Cover")
```

## #Calculate the mean and standard error for each species relative cover by plot. Make a bar graph of these means and standard errors, with plot on the x-axis and faceted by species, for the following species: Berberis thunbergii, Botrychium dissectum, Carex sp, Elaeagnus umbellata, Epifagus virginiana, Gallium circaezans, Ilex opaca, Lindera benzoin, Lonicera japonica, Mitchella repens, Parthenocissus quinquefolia, Polygonum virginianum, Rhus radicans, Rubus phoenicolasius, Sceptridium biternatum, Symphotrichium lateriflorum. Be sure to allow y-axis scale to vary in your facet statement.

```{r a true cluster}
species_cover_plot_mean_se <- dfplants %>%
  group_by(plot, species) %>%
  mutate(avg_rel_cover = mean(cover)) %>% mutate(stderror = std.error(cover)) %>% ungroup()

subsetneeded <-
  species_cover_plot_mean_se[species_cover_plot_mean_se$species %in% c("Berberis thunbergii", "Botrychium dissectum", "Carex sp", "Elaeagnus umbellata", "Epifagus virginiana", "Gallium circaezans", "Ilex opaca", "Lindera benzoin", "Lonicera japonica", "Mitchella repens", "Parthenocissus quinquefolia", "Polygonum virginianum", 
                       "Rhus radicans", "Rubus phoenicolasius", "Sceptridium biternatum", "Symphotrichium lateriflorum"),]

ggplot(subsetneeded, aes(x = plot, y = avg_rel_cover), fill = as.factor(plot)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = avg_rel_cover - stderror, 
                    ymax = avg_rel_cover + stderror)) +
  facet_wrap(~species, scales = "free")
```

# Summary 

In summary it seems that there are a wide range of plant responses as a result of the environment they are found. A deeper understanding of this plasticity may be useful in repairing or restoring ecosystems after disturbance has occurred. 




